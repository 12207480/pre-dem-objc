# SDK 发送缓存系统

## 目的
发送缓存系统旨在提供更可靠的消息发送机制，最大限度保证消息的可靠发送。

## 机制介绍
发送缓存系统主要有两个组件 `Persistence` 和 `Sender`，`Persistence` 主要负责缓存文件的管理工作，`Sender` 主要负责消息的组装及发送、重试等工作。每个监控子模块将采集到的数据直接交付给 `Persistence` 进行本地缓存。目前 `Persistence` 会将收到的每条消息都写入文件系统，`Sender` 会在 SDK 启动时进行一次发送尝试，之后每隔一定时间间隔进行一次发送尝试，`Sender` 在网络层不会进行重试，单次发送失败会在下次发送尝试阶段再进行重试发送，另外，在发送的时候从服务器获取到的一些状态变更由 `Sender` 通过 `Notification` 的方式进行广播，需要变更状态的模块通过监听 `Notification` 的方式进行相关状态的变更。

## 待讨论改进
- 是否改用数据库实现本地缓存
- 是否对一些数据进行 batch 再存储，通过牺牲可靠性来提高性能
- 是否需要在网络层进行发送重试
- 是否监控网络可达性，当网络可达时进行一次发送尝试
- 当网络变化之后是否丢弃之前监控的 http 数据
- 是否在 WiFi 环境下发送
